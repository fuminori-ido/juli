#!/usr/bin/env ruby
#
# = NAME
# juli    - Personal outline processor and wiki
#
# = SYNOPSIS
# juli [options] [files]
#
# = DESCRIPTION
# see doc/juli.txt for more detail.

$LOAD_PATH << File.join(File.dirname(__FILE__), '../lib')

require 'erb'
require 'fileutils'
require 'optparse'
require 'juli/command'


#------------------------------------------------------------------
# Global variable
#------------------------------------------------------------------
Version       = '0.01.0'


#------------------------------------------------------------------
# Subroutine Part
#------------------------------------------------------------------
def visitor_list
  result = []
  sorted_visitors = Dir.glob(File.join(Juli::PKG_ROOT, 'lib/juli/visitor/*.rb')).sort
  for f in sorted_visitors do
    next if f =~ /^\./
    result << File.basename(f).gsub(/\.rb$/, '')
  end
  'generator: ' + result.join(',') + ' (default=html)'
end


#------------------------------------------------------------------
# Main
#------------------------------------------------------------------
  include Juli::Command

  OPTS    = {:g=>'html'}
  command = 'gen'

  # parse common & default options
  parser = OptionParser.new(usage)

  subparsers = Hash.new{|h,k|
    $stderr.puts "no such juli command: #{k}"
    exit 1
  }
  s = subparsers['gen'] = OptionParser.new
  s.on('-g generator',  visitor_list){|v| OPTS[:g]  = v}
  s = subparsers['init'] = OptionParser.new
  s.on('-o output_top'){|v| OPTS[:o]  = v}

  parser.order!(ARGV)

  # check command
  command = ARGV.shift if !ARGV.empty?

  # parse command options
  subparsers[command].parse!(ARGV) if !ARGV.empty?

  Juli::Command::run(command, OPTS)
