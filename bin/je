#!/bin/sh
#
# = NAME
# je    - edit wikipage and run juli(1)
#
# = SYNOPSIS
# je wikiname
#
# = DESCRIPTION
# Please read html/je(1).html generated by
# juli(1) from doc/je(1).txt for the detail.

#-----------------------------------------------------------------
# Subroutines
#-----------------------------------------------------------------
usage(){
  echo "USAGE: je wikiname"
  exit 2
}

# check if $1 environment variable is set.
check_env(){
  value=`eval echo $"$1"`
  if [ "X$value" = "X" ]; then
    echo "ERROR: environment variable '$1' is not set."
    exit 2
  fi
}

run_juli(){
  if [ "X$JULI" = "X" ]; then
    juli $*
  else
    # for debug purpose
    ruby $JULI $*
  fi
}

#-----------------------------------------------------------------
# Main
#-----------------------------------------------------------------
  LOGFILE='/tmp/juli_je.log'
  wikiname=$1
  check_env 'JULI_REPO'
  check_env 'EDITOR'
  if [ "X$wikiname" = "X" ]; then
    usage
  fi

  cd $JULI_REPO
  test -f "$wikiname.txt"
  new_file=$?
  $EDITOR "$wikiname.txt"
  git add "$wikiname.txt"
  git commit -v "$wikiname.txt"

  juli_opts=''
  if [ $new_file -eq 1 ]; then
    echo
    echo "Re-generate other pages also since new page is added."
    echo "This will run in background because it may take long time."
    echo "See $LOGFILE later for the result."
    (
      date; echo "-- begin background task"
      run_juli gen -f
      run_juli sitemap
      run_juli recent_update
      date; echo "-- end background"; echo
    ) >>$LOGFILE 2>&1 &
  else
    run_juli
    run_juli recent_update
  fi
